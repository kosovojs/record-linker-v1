# API Specification

This document outlines the API endpoints for the backend. It is intended for frontend developers and other API consumers.

**Base URL:** `/api/v1`

---

## 1. Authentication

Handles user login, logout, and session management. Authentication is managed via a secure, `HttpOnly` session cookie.

### `POST /auth/login`

Authenticates a user and sets a session cookie.

-   **Description:** Provide email (as `username`) and password in a form data payload to receive a session cookie.
-   **Request Body:** `application/x-www-form-urlencoded`
    -   `username` (string, required): The user's email address.
    -   `password` (string, required): The user's password.
-   **Success Response (200 OK):**
    ```json
    {
      "email": "admin@example.com",
      "full_name": "Admin User",
      "uuid": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "role": "admin",
      "is_blocked": false,
      "last_authenticated_at": "2025-10-04T15:00:00.000Z",
      "created_at": "2025-10-01T10:00:00.000Z",
      "updated_at": "2025-10-01T10:00:00.000Z"
    }
    ```
-   **Error Responses:**
    -   `401 Unauthorized`: Incorrect email or password.
    -   `400 Bad Request`: User account is disabled.

### `POST /auth/logout`

Logs out the current user by deleting their session.

-   **Description:** Clears the session cookie and invalidates the session on the server.
-   **Success Response (200 OK):**
    ```json
    {
      "message": "Successfully logged out"
    }
    ```

### `GET /auth/me`

Retrieves the profile of the currently authenticated user.

-   **Permissions:** Authenticated user.
-   **Success Response (200 OK):** (Same structure as login response)
-   **Error Responses:**
    -   `401 Unauthorized`: No valid session cookie provided.

### `POST /auth/forgot-password`

Initiates password reset by sending a reset email.

-   **Request Body:** `application/json`
    ```json
    {
      "email": "user@example.com"
    }
    ```
-   **Success Response (200 OK):**
    ```json
    {
      "message": "If the email exists, a reset link has been sent."
    }
    ```

### `POST /auth/reset-password`

Resets the user's password using a reset token.

-   **Request Body:** `application/json`
    ```json
    {
      "token": "reset_token_string",
      "new_password": "new_password_here"
    }
    ```
-   **Success Response (200 OK):**
    ```json
    {
      "message": "Password has been reset successfully"
    }
    ```
-   **Error Responses:**
    -   `400 Bad Request`: Invalid or expired reset token.

---

## 2. Users

User management endpoints (admin only).

### `GET /users`

Lists all users.

-   **Permissions:** Admin only.
-   **Success Response (200 OK):** A JSON array of user objects with geocoding sources.

### `POST /users`

Creates a new user.

-   **Permissions:** Admin only.
-   **Request Body:** `application/json` (User creation data)
-   **Success Response (201 Created):** The created user object with geocoding sources.

### `GET /users/{user_id}`

Retrieves a specific user by UUID.

-   **Permissions:** Admin only.
-   **Success Response (200 OK):** A single user object with geocoding sources.
-   **Error Responses:**
    -   `404 Not Found`: User not found.

### `PUT /users/{user_id}`

Updates a user.

-   **Permissions:** Admin only.
-   **Request Body:** `application/json` (User update data)
-   **Success Response (200 OK):** The updated user object with geocoding sources.
-   **Error Responses:**
    -   `404 Not Found`: User not found.

---

## 3. API Tokens

API token management for authentication.

### `GET /api-tokens`

Lists API tokens for the current user.

-   **Permissions:** Authenticated user.
-   **Success Response (200 OK):** A JSON array of API token objects.

### `POST /api-tokens`

Creates a new API token for the current user.

-   **Permissions:** Authenticated user.
-   **Request Body:** `application/json` (Token creation data)
-   **Success Response (201 Created):**
    ```json
    {
      "token": { /* ApiTokenRead */ },
      "raw_token": "the_raw_token_string"
    }
    ```

### `PUT /api-tokens/{token_id}`

Updates an API token for the current user.

-   **Permissions:** Authenticated user.
-   **Request Body:** `application/json` (Token update data)
-   **Success Response (200 OK):** The updated API token object.
-   **Error Responses:**
    -   `404 Not Found`: API token not found.

### `DELETE /api-tokens/{token_id}`

Deletes an API token for the current user.

-   **Permissions:** Authenticated user.
-   **Success Response (200 OK):**
    ```json
    {
      "message": "API token deleted successfully"
    }
    ```
-   **Error Responses:**
    -   `404 Not Found`: API token not found.

### `GET /api-tokens/admin/{user_id}`

Lists API tokens for a specific user (admin only).

-   **Permissions:** Admin only.
-   **Success Response (200 OK):** A JSON array of API token objects.

### `POST /api-tokens/admin/{user_id}`

Creates a new API token for a specific user (admin only).

-   **Permissions:** Admin only.
-   **Request Body:** `application/json` (Token creation data)
-   **Success Response (201 Created):**
    ```json
    {
      "token": { /* ApiTokenRead */ },
      "raw_token": "the_raw_token_string"
    }
    ```

### `PUT /api-tokens/admin/{user_id}/{token_id}`

Updates an API token for a specific user (admin only).

-   **Permissions:** Admin only.
-   **Request Body:** `application/json` (Token update data)
-   **Success Response (200 OK):** The updated API token object.
-   **Error Responses:**
    -   `404 Not Found`: API token not found.

### `DELETE /api-tokens/admin/{user_id}/{token_id}`

Deletes an API token for a specific user (admin only).

-   **Permissions:** Admin only.
-   **Success Response (200 OK):**
    ```json
    {
      "message": "API token deleted successfully"
    }
    ```
-   **Error Responses:**
    -   `404 Not Found`: API token not found.

---

## 4. Projects

Projects are the top-level containers for geocoding jobs.

### `POST /projects`

Creates a new project.

-   **Permissions:** Authenticated user.
-   **Request Body:** `application/json`
    ```json
    {
      "name": "Downtown Manhattan Addresses",
      "description": "Geocoding all addresses in the downtown area for Q4 analysis.",
      "metadata": { "client_id": "XYZ-123" }
    }
    ```
-   **Success Response (201 Created):**
    ```json
    {
      "name": "Downtown Manhattan Addresses",
      "description": "Geocoding all addresses in the downtown area for Q4 analysis.",
      "metadata": { "client_id": "XYZ-123" },
      "uuid": "f1a2b3c4-d5e6-f7a8-b9c0-d1e2f3a4b5c6"
    }
    ```

### `GET /projects`

Lists projects visible to the current user.

-   **Permissions:** Authenticated user. Admins see all projects; regular users see only projects they are members of.
-   **Query Parameters:**
    -   `skip` (int, optional, default: 0)
    -   `limit` (int, optional, default: 100)
-   **Success Response (200 OK):** A JSON array of project objects.

### `GET /projects/{project_uuid}`

Retrieves a single project.

-   **Permissions:** Project member or Admin.
-   **Success Response (200 OK):** A single project object.

### `POST /projects/{project_uuid}/tasks/upload-csv`

Creates geocoding tasks by uploading a CSV file.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `multipart/form-data`
    -   `file`: The CSV file.
    -   `mapping`: A JSON string describing how CSV columns map to task data.
        -   **Example `mapping` string:**
            ```json
            {
              "address_fields": {
                "street": "Address",
                "city": "City",
                "zip": "PostalCode"
              },
              "metadata_fields": {
                "original_id": "CustomerID",
                "source_system": "System"
              }
            }
            ```
-   **Success Response (202 Accepted):**
    ```json
    {
      "message": "Successfully created 1500 tasks."
    }
    ```
-   **Error Responses:**
    -   `400 Bad Request`: CSV is missing a required column or is empty.
    -   `422 Unprocessable Entity`: The `mapping` JSON is malformed.

### `POST /projects/{project_uuid}/tasks/upload-json`

Creates geocoding tasks by uploading a JSON file.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `multipart/form-data`
    -   `file`: The JSON file (array of objects).
    -   `mapping`: A JSON string describing how JSON keys map to task data.
        -   **Example `mapping` string:**
            ```json
            {
              "address_fields": {
                "street": "street",
                "city": "city"
              },
              "metadata_fields": {
                "original_id": "id"
              }
            }
            ```
-   **Success Response (202 Accepted):**
    ```json
    {
      "message": "Successfully created 1500 tasks."
    }
    ```
-   **Error Responses:**
    -   `400 Bad Request`: JSON is malformed or empty.
    -   `422 Unprocessable Entity`: The `mapping` JSON is malformed.

### `POST /projects/{project_uuid}/rerun-geocoding`

Reruns geocoding for tasks matching specified criteria.

-   **Permissions:** Project member or Admin.
-   **Query Parameters:**
    -   `criteria` (string, optional): 'no_candidates', 'no_approved_candidates', 'failed_tasks'
    -   `status_ids` (list[int], optional): List of status IDs to rerun
-   **Success Response (202 Accepted):**
    ```json
    {
      "message": "Successfully reset X tasks for geocoding rerun",
      "tasks_reset": 123,
      "criteria": "no_candidates",
      "status_ids": [1, 2]
    }
    ```
-   **Error Responses:**
    -   `400 Bad Request`: Invalid criteria or missing parameters.

### `GET /projects/{project_uuid}/events`

Retrieves project events.

-   **Permissions:** Project member or Admin.
-   **Query Parameters:**
    -   `skip` (int, optional, default: 0)
    -   `limit` (int, optional, default: 100)
-   **Success Response (200 OK):** Paginated list of project events.

### `GET /projects/{project_uuid}/events/summary`

Retrieves project task events summary.

-   **Permissions:** Project member or Admin.
-   **Query Parameters:**
    -   `breakdown` (string, optional, default: 'month'): 'month' or 'date'
-   **Success Response (200 OK):** Event summary grouped by month or date.

### `DELETE /projects/{project_uuid}`

Deletes a project.

-   **Permissions:** Project member or Admin (owner).
-   **Success Response (204 No Content):**

### `PATCH /projects/{project_uuid}`

Updates a project.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `application/json` (Project update data)
-   **Success Response (200 OK):** The updated project object.

### `GET /projects/batches/{batch_uuid}`

Gets project information for a batch UUID.

-   **Permissions:** Authenticated user with access to the project.
-   **Success Response (200 OK):** Project object.

### `GET /projects/{project_uuid}/batches`

Gets all batches for a project.

-   **Permissions:** Project member or Admin.
-   **Success Response (200 OK):** List of batch objects with task statistics.

### `POST /projects/{project_uuid}/batches`

Re-batches tasks in the project.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `application/json`
    ```json
    {
      "size": 100,
      "strategy": "sequential"  // or "group_completed", "distribute_completed"
    }
    ```
-   **Success Response (201 Created):**
    ```json
    {
      "message": "Successfully created X batches",
      "batches_created": 5,
      "batch_size": 100,
      "strategy": "sequential"
    }
    ```

---

## 3. Tasks

Tasks represent individual records to be geocoded.

### `GET /projects/{project_uuid}/tasks`

Lists tasks for a project, with pagination and filtering.

-   **Permissions:** Project member or Admin.
-   **Query Parameters:**
    -   `status` (string, optional): Filter by status (e.g., `pending`, `needs_review`).
    -   `cursor` (int, optional): For pagination. The ID of the last item seen.
    -   `limit` (int, optional, default: 100).
-   **Success Response (200 OK):** A JSON array of task objects.
    ```json
    [
      {
        "input_data": { "street": "123 Main St", "city": "Anytown" },
        "status": "pending",
        "tags": [],
        "metadata": { "original_id": "CUST-001" },
        "uuid": "c1a2b3c4-...",
        "project_id": 1,
        "batch_id": null,
        "selected_candidate_id": null,
        "candidates": []
      }
    ]
    ```

### `POST /projects/{project_uuid}/tasks`

Creates a batch of tasks from a JSON payload.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `application/json` (An array of task objects to create)
    ```json
    [
      {
        "input_data": { "address": "456 Oak Ave, Otherville" },
        "metadata": { "source": "API" }
      },
      {
        "input_data": { "address": "789 Pine Ln, Sometown" }
      }
    ]
    ```
-   **Success Response (201 Created):** A JSON array of the newly created task objects.

### `GET /projects/{project_uuid}/tasks/{task_uuid}`

Retrieves a single task.

-   **Permissions:** Project member or Admin.
-   **Success Response (200 OK):** A single task object.

### `PATCH /projects/{project_uuid}/tasks/{task_uuid}`

Updates a single task.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `application/json`
    ```json
    {
      "status": "needs_review",
      "tags": ["high_priority", "unusual_format"],
      "selected_candidate_id": 123
    }
    ```
-   **Success Response (200 OK):** The updated task object.

### `POST /projects/{project_uuid}/tasks/import`

Imports tasks with optional candidates.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `application/json` (Array of task import objects)
-   **Success Response (204 No Content):**

### `GET /projects/{project_uuid}/approved-candidates`

Gets approved candidates for all completed tasks in the project.

-   **Permissions:** Project member or Admin.
-   **Success Response (200 OK):** Dictionary mapping task UUIDs to candidate data.

### `PATCH /projects/{project_uuid}/tasks/{task_uuid}/candidates/order`

Updates the order of candidates for a task.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `application/json`
    ```json
    {
      "candidate_uuids": ["uuid1", "uuid2"]
    }
    ```
-   **Success Response (200 OK):** The updated task object.

### `GET /projects/{project_uuid}/tasks/export/geojson`

Exports approved tasks as GeoJSON.

-   **Permissions:** Project member or Admin.
-   **Success Response (200 OK):** GeoJSON FeatureCollection file download.

### `GET /projects/{project_uuid}/tasks/export/csv`

Exports approved tasks as CSV.

-   **Permissions:** Project member or Admin.
-   **Success Response (200 OK):** CSV file download with lat, lon, address columns.

---

## 6. Candidates

Candidates are potential geocoded matches for a task.

### `POST /projects/{project_uuid}/tasks/{task_uuid}/candidates`

Creates a batch of candidates for a task.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `application/json` (An array of candidate objects to create)
    ```json
    [
      {
        "task_id": 5, // Must match the internal ID of the task
        "source_name": "Google Maps API",
        "confidence_score": 0.95,
        "address_data": { "formatted_address": "123 Main Street, Anytown, USA" },
        "location": "POINT(-74.0060 40.7128)"
      }
    ]
    ```
-   **Success Response (201 Created):** A JSON array of the created candidate objects.

### `PATCH /projects/{project_uuid}/tasks/{task_uuid}/candidates`

Updates multiple candidates for a task in a single request.

-   **Permissions:** Project member or Admin.
-   **Request Body:** `application/json`
    ```json
    {
      "candidate_uuids": [
        "e1f2a3b4-...",
        "d5c6b7a8-..."
      ],
      "updates": {
        "status": "rejected",
        "tags": ["low_confidence"]
      }
    }
    ```
-   **Success Response (200 OK):** A JSON array of the updated candidate objects.

---

## 5. Candidate Sources

Endpoints for managing candidate sources.

### `GET /candidates/sources`

Gets candidate sources available to the current user.

-   **Permissions:** Authenticated user.
-   **Success Response (200 OK):** List of candidate source objects.

### `GET /candidates/search`

Searches for candidates using geocoding services.

-   **Permissions:** Authenticated user.
-   **Query Parameters:**
    -   `query` (string, optional): Search query string
    -   `lat` (float, optional): Latitude for reverse geocoding
    -   `lng` (float, optional): Longitude for reverse geocoding
    -   `engine` (string, optional): Specific search engine code
-   **Success Response (200 OK):** List of candidate objects.
-   **Error Responses:**
    -   `400 Bad Request`: Neither query nor lat/lng provided.

---

## 6. Admin - Candidate Sources

Admin endpoints for managing candidate sources.

### `GET /admin/sources`

Gets all candidate sources.

-   **Permissions:** Admin only.
-   **Success Response (200 OK):** List of all candidate source objects.

### `POST /admin/sources`

Creates a new candidate source.

-   **Permissions:** Admin only.
-   **Request Body:** `application/json` (Source creation data)
-   **Success Response (201 Created):** The created source object.

### `GET /admin/sources/{source_id}`

Gets a specific source by ID.

-   **Permissions:** Admin only.
-   **Success Response (200 OK):** Single source object.
-   **Error Responses:**
    -   `404 Not Found`: Source not found.

### `PUT /admin/sources/{source_id}`

Updates a source.

-   **Permissions:** Admin only.
-   **Request Body:** `application/json` (Source update data)
-   **Success Response (200 OK):** The updated source object.
-   **Error Responses:**
    -   `404 Not Found`: Source not found.

### `DELETE /admin/sources/{source_id}`

Deletes a source.

-   **Permissions:** Admin only.
-   **Success Response (200 OK):**
    ```json
    {
      "message": "Source deleted successfully"
    }
    ```
-   **Error Responses:**
    -   `404 Not Found`: Source not found.

---

## 7. Task Statuses

Endpoints for task status management.

### `GET /task-statuses`

Returns all possible task statuses.

-   **Success Response (200 OK):** List of task status objects.

### `GET /status-presets`

Returns all status presets.

-   **Success Response (200 OK):** List of status preset objects.
```
